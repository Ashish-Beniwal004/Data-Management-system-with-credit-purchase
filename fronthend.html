<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Retail Loan & Inventory — Frontend</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg: #f7fafc;
      --card: #ffffff;
      --muted: #6b7280;
      --accent: #6c8efb;
      --radius: 12px;
    }
    html,body{height:100%;}
    body{
      background: linear-gradient(180deg, var(--bg) 0%, #ffffff 100%);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    .sidebar {
      min-width: 240px;
      max-width: 240px;
      height: 100vh;
      position: sticky;
      top: 0;
      background: white;
      border-right: 1px solid #e6edf8;
      box-shadow: 0 2px 6px rgba(16,24,40,0.04);
      padding: 1rem;
    }
    .nav-link { color: #374151; border-radius: 8px; }
    .nav-link.active { background: linear-gradient(90deg,#eef2ff,#f7fbff); color: #0f172a; font-weight:600; }
    .card-soft { background: var(--card); border-radius: var(--radius); box-shadow: 0 6px 18px rgba(16,24,40,0.06); }
    .search-input { max-width: 360px; }
    .table-wrap { overflow:auto; max-height:58vh;}
    main { padding: 1.25rem; }
    .muted { color: var(--muted); }
    @media (max-width: 992px) {
      .sidebar { position: relative; height: auto; max-width: 100%; }
    }
  </style>
</head>
<body>

<div class="d-flex">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="mb-4">
      <h5 class="mb-0">Retail Loan Inventory</h5>
      <small class="text-muted">Admin Dashboard</small>
    </div>

    <nav class="nav flex-column gap-1">
      <a class="nav-link active" href="#" data-target="dashboard"><i class="bi bi-bar-chart-line me-2"></i> Dashboard</a>
      <a class="nav-link" href="#" data-target="customers"><i class="bi bi-people me-2"></i> Customers</a>
      <a class="nav-link" href="#" data-target="suppliers"><i class="bi bi-truck me-2"></i> Suppliers</a>
      <a class="nav-link" href="#" data-target="products"><i class="bi bi-box-seam me-2"></i> Products</a>
      <a class="nav-link" href="#" data-target="stock"><i class="bi bi-stack me-2"></i> Stock</a>
      <a class="nav-link" href="#" data-target="sales"><i class="bi bi-receipt me-2"></i> Sales</a>
      <a class="nav-link" href="#" data-target="invoices"><i class="bi bi-file-text me-2"></i> Invoices</a>
      <a class="nav-link" href="#" data-target="loans"><i class="bi bi-cash-stack me-2"></i> Loans</a>
      <a class="nav-link" href="#" data-target="payments"><i class="bi bi-credit-card me-2"></i> Payments</a>
    </nav>

    <hr>
    <div class="mt-3">
      <small class="muted">Quick Actions</small>
      <div class="d-grid gap-2 mt-2">
        <button class="btn btn-outline-primary btn-sm" id="addQuickCustomer">+ New Customer</button>
        <button class="btn btn-outline-success btn-sm" id="addQuickProduct">+ New Product</button>
      </div>
    </div>
  </aside>

  <!-- Main content -->
  <div class="flex-fill">
    <main>
      <!-- Dashboard -->
      <section id="dashboard" class="view">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h4 class="mb-0">Dashboard</h4>
            <small class="muted">Overview of business KPIs</small>
          </div>
          <div class="d-flex gap-2">
            <input class="form-control form-control-sm search-input" id="globalSearch" placeholder="Search across current view...">
            <button class="btn btn-outline-secondary btn-sm" id="refreshBtn"><i class="bi bi-arrow-clockwise"></i></button>
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-sm-6 col-md-3">
            <div class="p-3 card-soft">
              <small class="muted">Total Customers</small>
              <div class="h4 mt-2" id="cardCustomers">0</div>
            </div>
          </div>
          <div class="col-sm-6 col-md-3">
            <div class="p-3 card-soft">
              <small class="muted">Total Products</small>
              <div class="h4 mt-2" id="cardProducts">0</div>
            </div>
          </div>
          <div class="col-sm-6 col-md-3">
            <div class="p-3 card-soft">
              <small class="muted">Total Loans</small>
              <div class="h4 mt-2" id="cardLoans">0</div>
            </div>
          </div>
          <div class="col-sm-6 col-md-3">
            <div class="p-3 card-soft">
              <small class="muted">Pending Payments</small>
              <div class="h4 mt-2" id="cardPending">0</div>
            </div>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-lg-6">
            <div class="card-soft p-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>Monthly Sales</strong>
                <small class="muted">Last 6 months</small>
              </div>
              <canvas id="salesChart" height="150"></canvas>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="card-soft p-3 mb-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>Loan Repayments</strong>
                <small class="muted">Monthly</small>
              </div>
              <canvas id="loanChart" height="150"></canvas>
            </div>

            <div class="card-soft p-3 mt-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>Stock Updates</strong>
                <small class="muted">Recent</small>
              </div>
              <canvas id="stockChart" height="80"></canvas>
            </div>
          </div>
        </div>
      </section>

      <!-- Generic Table template for CRUD views -->
      <template id="crud-template">
        <div class="card-soft p-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h5 class="mb-0" data-title></h5>
              <small class="muted" data-sub></small>
            </div>
            <div class="d-flex gap-2 align-items-center">
              <input class="form-control form-control-sm search-input" placeholder="Search table..." data-search>
              <button class="btn btn-primary btn-sm" data-add>+ Add</button>
            </div>
          </div>
          <div class="table-wrap">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr data-headers></tr>
              </thead>
              <tbody data-body></tbody>
            </table>
          </div>
        </div>
      </template>

      <!-- Customers -->
      <section id="customers" class="view" style="display:none">
        <!-- Content injected by JS -->
      </section>

      <!-- Suppliers -->
      <section id="suppliers" class="view" style="display:none"></section>

      <!-- Products -->
      <section id="products" class="view" style="display:none"></section>

      <!-- Stock -->
      <section id="stock" class="view" style="display:none"></section>

      <!-- Sales -->
      <section id="sales" class="view" style="display:none"></section>

      <!-- Invoices -->
      <section id="invoices" class="view" style="display:none"></section>

      <!-- Loans -->
      <section id="loans" class="view" style="display:none"></section>

      <!-- Payments -->
      <section id="payments" class="view" style="display:none"></section>

    </main>
  </div>
</div>

<!-- Modal: Generic Add/Edit (dynamic fields) -->
<div class="modal fade" id="entityModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <form class="modal-content" id="entityForm" novalidate>
      <div class="modal-header">
        <h5 class="modal-title" id="entityModalTitle">Add Item</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="modalFields" class="row g-3"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-sm btn-primary">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Toast area -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1100">
  <div id="toastContainer"></div>
</div>

<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* -----------------------------
  Sample in-memory datasets
   (Replace with API calls to backend)
   ----------------------------- */
let data = {
  customers: [],
  suppliers: [],
  products: [],
  stock: [],
  sales: [],
  invoices: [],
  loans: [],
  payments: []
};

// Fetch all data from backend
// Fetch all data from backend (robust)
async function fetchAllData() {
  function ensureArray(x, name) {
    if (Array.isArray(x)) return x;
    if (x == null) {
      console.warn(`[fetchAllData] ${name} is null/undefined, coercing to []`);
      return [];
    }
    // If it's an object (single row), wrap in array
    if (typeof x === 'object') {
      console.warn(`[fetchAllData] ${name} was object, wrapping into array`, x);
      return [x];
    }
    // otherwise log & coerce
    console.warn(`[fetchAllData] ${name} unexpected type (${typeof x}), coercing to []:`, x);
    return [];
  }

  try {
    const responses = await Promise.all([
      fetch('http://localhost:4000/api/customers'),
      fetch('http://localhost:4000/api/suppliers'),
      fetch('http://localhost:4000/api/products'),
      fetch('http://localhost:4000/api/stock'),
      fetch('http://localhost:4000/api/sales'),
      fetch('http://localhost:4000/api/invoices'),
      fetch('http://localhost:4000/api/loans'),
      fetch('http://localhost:4000/api/payments')
    ]);

    // check each response status
    for (let i = 0; i < responses.length; i++) {
      if (!responses[i].ok) {
        console.error(`[fetchAllData] HTTP error for request ${i}:`, responses[i].status, responses[i].statusText);
        throw new Error('One or more backend requests failed');
      }
    }

    // parse JSON
    const [custResp, suppResp, prodResp, stockResp, salesResp, invResp, loanResp, payResp] = await Promise.all(
      responses.map(r => r.json().catch(err => { console.error('JSON parse failed', err); return null; }))
    );

    // Extract data arrays (check if wrapped in response object)
   const extractData = (resp) => {
      // Backend is already returning arrays, so just return them directly
      if (Array.isArray(resp)) return resp;
      
      // Fallback for edge cases
      if (resp?.data && Array.isArray(resp.data)) return resp.data;
      if (resp?.result && Array.isArray(resp.result)) return resp.result;
      
      // If nothing works, return empty array
      return [];
    };

    // ✅ ADD THESE LINES - Assign extracted data to the data object
    data.customers = extractData(custResp);
    data.suppliers = extractData(suppResp);
    data.products = extractData(prodResp);
    data.stock = extractData(stockResp);
    data.sales = extractData(salesResp);
    data.invoices = extractData(invResp);
    data.loans = extractData(loanResp);
    data.payments = extractData(payResp);

    console.log('✅ Data loaded:', data); // Debug log

    // call renders
    refreshDashboard();       // update cards/charts
    renderCrudView('customers'); // show customers by default
    showToast('✅ Data loaded from backend', 'success');
  } catch (err) {
    console.error('Backend fetch failed:', err);
    showToast('❌ Failed to connect to backend', 'danger');
  }
}
/* -----------------------------
  Utilities
  ----------------------------- */
function $(sel, ctx = document) { return ctx.querySelector(sel); }
function $all(sel, ctx = document) { return Array.from(ctx.querySelectorAll(sel)); }
function showToast(msg, type='info') {
  const id = 't' + Date.now();
  const toast = document.createElement('div');
  toast.className = `toast align-items-center text-bg-${type} border-0`;
  toast.role = 'alert';
  toast.ariaLive = 'assertive';
  toast.ariaAtomic = 'true';
  toast.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div>
    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
  $('#toastContainer').appendChild(toast);
  const btoast = new bootstrap.Toast(toast, { delay: 3000 });
  btoast.show();
  toast.addEventListener('hidden.bs.toast', ()=>toast.remove());
}

/* -----------------------------
  Navigation handling
  ----------------------------- */
const navLinks = $all('.nav-link');
navLinks.forEach(link => {
  link.addEventListener('click', e => {
    e.preventDefault();
    navLinks.forEach(l=>l.classList.remove('active'));
    link.classList.add('active');
    const target = link.dataset.target;
    $all('.view').forEach(v => v.style.display = (v.id===target ? '' : 'none'));
    if (target!=='dashboard') renderCrudView(target);
    if (target==='dashboard') refreshDashboard();
  });
});

/* -----------------------------
  Dashboard charts and cards
  ----------------------------- */
function refreshDashboard() {
  try {
    // safe shortcuts
    const customers = Array.isArray(data.customers) ? data.customers : [];
    const products  = Array.isArray(data.products) ? data.products : [];
    const loans     = Array.isArray(data.loans) ? data.loans : [];
    const payments  = Array.isArray(data.payments) ? data.payments : [];

    // totals (safe)
    const totalCustomers = customers.length;
    const totalProducts  = products.length;
    const totalLoans     = loans.length;
    // pending payments: sum balances safely
    const pendingPayments = loans.reduce((acc, l) => {
      const bal = (l && typeof l.balance === 'number') ? l.balance : (Number(l && l.balance) || 0);
      return acc + bal;
    }, 0);

    // update DOM cards (use your existing selectors)
    const setText = (sel, txt) => { const el = document.querySelector(sel); if (el) el.textContent = txt; };
    setText('#cardCustomers', totalCustomers);  // adjust selectors to your actual IDs/classes
    setText('#cardProducts', totalProducts);
    setText('#cardLoans', totalLoans);
    setText('#cardPending', pendingPayments);

    // Example: Monthly sales chart (guarded)
    // If you create charts using Chart.js, ensure config exists before accessing datasets
    try {
      const salesByMonth = (Array.isArray(data.sales) ? data.sales : []).reduce((acc, s) => {
        // assume s.date or s.date_added exists; normalize to YYYY-MM
        const d = new Date(s.date || s.payment_date || s.date_added || Date.now());
        const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        acc[key] = (acc[key] || 0) + (Number(s.price_total || s.amount_paid || 0) || 0);
        return acc;
      }, {});
      // build labels & values
      const labels = Object.keys(salesByMonth).sort();
      const values = labels.map(k => salesByMonth[k]);

      // only create/update chart if canvas exists
      const salesCanvas = document.querySelector('#monthlySalesChart');
      if (salesCanvas) {
        // If you use Chart.js, destroy previous instance stored on element to avoid errors
        if (salesCanvas._chartInstance) {
          try { salesCanvas._chartInstance.destroy(); } catch(e){ /* ignore */ }
        }
        // create a new chart only if we have data
        if (labels.length) {
          const ctx = salesCanvas.getContext('2d');
          // eslint-disable-next-line no-undef
          salesCanvas._chartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [{ label: 'Sales', data: values }] },
            options: {}
          });
        }
      }
    } catch (chartErr) {
      console.warn('Chart update failed:', chartErr);
    }

    // stock updates / loan repayments widgets: guard similarly...
  } catch (err) {
    console.error('refreshDashboard error:', err);
  }
}


/* -----------------------------
  CRUD view renderer (generic)
  ----------------------------- */
const defs = {
  customers: {
    title:'Customers', sub:'Add, edit and manage customers',
    headers:['ID','Name','Email','Phone','City','Actions'],
    fields: [
      {name:'cust_id', label:'Customer ID', type:'text', required:true},
      {name:'cust_name', label:'Full Name', type:'text', required:true},
      {name:'email', label:'Email', type:'email'},
      {name:'phone_no', label:'Phone Number', type:'tel'},
      {name:'house_no', label:'House No', type:'text'},
      {name:'street_name', label:'Street', type:'text'},
      {name:'city_name', label:'City', type:'text'}
    ]
  },
  suppliers: {
    title:'Suppliers', sub:'Manage supplier details',
    headers:['ID','Name','Enterprise','Email','Phone','Actions'],
    fields:[
      {name:'supplier_id', label:'Supplier ID', type:'text', required:true},
      {name:'supplier_name', label:'Name', type:'text', required:true},
      {name:'enterprise_name', label:'Enterprise Name', type:'text'},
      {name:'email_id', label:'Email', type:'email'},
      {name:'phone_no', label:'Phone', type:'tel'},
      {name:'address', label:'Address', type:'text'}
    ]
  },
  products: {
    title:'Products', sub:'Products & inventory',
    headers:['ID','Name','Category','Price','Qty','Supplier','Actions'],
    fields:[
      {name:'product_id', label:'Product ID', type:'text', required:true},
      {name:'product_name', label:'Product Name', type:'text', required:true},
      {name:'category', label:'Category', type:'text'},
      {name:'price', label:'Price', type:'number', step:'0.01'},
      {name:'quantity_stock', label:'Quantity', type:'number'},
      {name:'supplier_id', label:'Supplier ID', type:'text'}
    ]
  },
  stock: {
    title:'Stock', sub:'Stock intake & updates',
    headers:['Stock ID','Product','Supplier','Qty','Date','Actions'],
    fields:[
      {name:'stock_id', label:'Stock ID', type:'text', required:true},
      {name:'product_id', label:'Product ID', type:'text', required:true},
      {name:'supplier_id', label:'Supplier ID', type:'text'},
      {name:'quantity', label:'Quantity', type:'number', required:true},
      {name:'date_added', label:'Date Added', type:'date'}
    ]
  },
  sales: {
    title:'Sales', sub:'Record product sales',
    headers:['Sale ID','Product','Invoice','Qty','Total','Actions'],
    fields:[
      {name:'sales_id', label:'Sale ID', type:'text', required:true},
      {name:'product_id', label:'Product ID', type:'text', required:true},
      {name:'invoice_id', label:'Invoice ID', type:'text'},
      {name:'quantity_sold', label:'Quantity Sold', type:'number', required:true},
      {name:'price_total', label:'Total Price', type:'number', step:'0.01'}
    ]
  },
  invoices: {
    title:'Invoices', sub:'Generate invoices',
    headers:['Invoice ID','Customer','Total','Date','Payment','Actions'],
    fields:[
      {name:'invoice_id', label:'Invoice ID', type:'text', required:true},
      {name:'cust_id', label:'Customer ID', type:'text'},
      {name:'total_amt', label:'Total Amount', type:'number'},
      {name:'date', label:'Date', type:'date'},
      {name:'payment_mode', label:'Payment Mode', type:'text'}
    ]
  },
  loans: {
    title:'Loans', sub:'Record & manage loans',
    headers:['Loan ID','Customer','Amount','Interest','Balance','Actions'],
    fields:[
      {name:'loan_id', label:'Loan ID', type:'text', required:true},
      {name:'cust_id', label:'Customer ID', type:'text'},
      {name:'loan_amount', label:'Loan Amount', type:'number'},
      {name:'interest_rate', label:'Interest Rate (%)', type:'number'},
      {name:'balance', label:'Balance', type:'number'}
    ]
  },
  payments: {
    title:'Loan Payments', sub:'Record repayments',
    headers:['Pay ID','Loan','Date','Amount','Mode','Actions'],
    fields:[
      {name:'pay_id', label:'Payment ID', type:'text', required:true},
      {name:'loan_id', label:'Loan ID', type:'text'},
      {name:'payment_date', label:'Date', type:'date'},
      {name:'amount_paid', label:'Amount Paid', type:'number'},
      {name:'payment_mode', label:'Payment Mode', type:'text'}
    ]
  }
};

function renderCrudView(key){
  const container = document.getElementById(key);
  container.innerHTML = '';
  const temp = document.getElementById('crud-template').content.cloneNode(true);
  const title = temp.querySelector('[data-title]');
  const sub = temp.querySelector('[data-sub]');
  const headersRow = temp.querySelector('[data-headers]');
  const body = temp.querySelector('[data-body]');
  const searchInput = temp.querySelector('[data-search]');
  const addBtn = temp.querySelector('[data-add]');

  title.textContent = defs[key].title;
  sub.textContent = defs[key].sub;

  // headers
  defs[key].headers.forEach(h => {
    const th = document.createElement('th');
    th.textContent = h;
    headersRow.appendChild(th);
  });

  // populate rows
  function refreshRows(filter=''){
    body.innerHTML = '';
    const list = (data[key] || []);
    list.forEach((item, idx) => {
      const tr = document.createElement('tr');

      // columns mapping (simplified)
      if (key === 'customers') {
        tr.innerHTML = `<td>${item.cust_id}</td><td>${item.cust_name}</td><td>${item.email||''}</td><td>${item.phone_no||''}</td><td>${item.address?.city_name||''}</td>`;
      } else if (key === 'suppliers') {
        tr.innerHTML = `<td>${item.supplier_id}</td><td>${item.supplier_name}</td><td>${item.enterprise_name||''}</td><td>${item.email_id||''}</td><td>${item.phone_no||''}</td>`;
      } else if (key === 'products') {
        tr.innerHTML = `<td>${item.product_id}</td><td>${item.product_name}</td><td>${item.category||''}</td><td>${item.price||''}</td><td>${item.quantity_stock||0}</td><td>${item.supplier_id||''}</td>`;
      } else if (key === 'stock') {
        tr.innerHTML = `<td>${item.stock_id}</td><td>${item.product_id}</td><td>${item.supplier_id||''}</td><td>${item.quantity}</td><td>${item.date_added||''}</td>`;
      } else if (key === 'sales') {
        tr.innerHTML = `<td>${item.sales_id}</td><td>${item.product_id}</td><td>${item.invoice_id||''}</td><td>${item.quantity_sold}</td><td>${item.price_total||''}</td>`;
      } else if (key === 'invoices') {
        tr.innerHTML = `<td>${item.invoice_id}</td><td>${item.cust_id||''}</td><td>${item.total_amt||''}</td><td>${item.date||''}</td><td>${item.payment_mode||''}</td>`;
      } else if (key === 'loans') {
        tr.innerHTML = `<td>${item.loan_id}</td><td>${item.cust_id||''}</td><td>${item.loan_amount||''}</td><td>${item.interest_rate||''}</td><td>${item.balance||''}</td>`;
      } else if (key === 'payments') {
        tr.innerHTML = `<td>${item.pay_id}</td><td>${item.loan_id||''}</td><td>${item.payment_date||''}</td><td>${item.amount_paid||''}</td><td>${item.payment_mode||''}</td>`;
      }

      // actions
      const actionsTd = document.createElement('td');
      actionsTd.innerHTML = `
        <button class="btn btn-sm btn-outline-primary me-1" data-edit> <i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-outline-danger" data-delete> <i class="bi bi-trash"></i></button>`;
      tr.appendChild(actionsTd);

      // filter check
      const text = tr.textContent.toLowerCase();
      if (!filter || text.includes(filter.toLowerCase())) body.appendChild(tr);

      // attach edit/delete handlers
      actionsTd.querySelector('[data-edit]').addEventListener('click', ()=> openModalForKey(key, item, idx));
        actionsTd.querySelector('[data-delete]').addEventListener('click', ()=> {
  if (confirm('Delete this record?')) {
    const idField = defs[key].fields[0].name;
    const id = item[idField];
    fetch(`http://localhost:4000/api/${key}/${id}`, { method: 'DELETE' })
      .then(r => r.json())
      .then(resp => {
        showToast(resp.message || 'Deleted', 'warning');
        fetchAllData();
      })
      .catch(err => {
        console.error(err);
        showToast('Delete failed', 'danger');
      });
  }
});

    });
  }

  searchInput.addEventListener('input', ()=> refreshRows(searchInput.value));
  refreshRows();

  addBtn.addEventListener('click', ()=> openModalForKey(key));

  container.appendChild(temp);
}

/* -----------------------------
  Generic Modal: Build form & handle saving
  ----------------------------- */
const entityModalEl = document.getElementById('entityModal');
const entityModal = new bootstrap.Modal(entityModalEl);
let currentEditing = { key:null, idx:null };

function openModalForKey(key, item=null, idx=null){
  currentEditing.key = key;
  currentEditing.idx = idx;
  const title = $('#entityModalTitle');
  const fieldsWrap = $('#modalFields');
  const def = defs[key];
  fieldsWrap.innerHTML = '';

  title.textContent = (item ? `Edit ${def.title.slice(0,-1)}` : `Add ${def.title.slice(0,-1)}`);

  def.fields.forEach(f => {
    const col = document.createElement('div');
    col.className = 'col-md-6';
    let value = '';
    // nested for customers address fields
    if (item) {
      if (key==='customers' && ['house_no','street_name','city_name'].includes(f.name)) {
        value = item.address?.[f.name] || '';
      } else {
        value = item[f.name] ?? '';
      }
    }
    col.innerHTML = `
      <label class="form-label small mb-1">${f.label}${f.required ? ' *' : ''}</label>
      <input name="${f.name}" class="form-control form-control-sm" type="${f.type}" ${f.step ? `step="${f.step}"` : ''} ${f.required ? 'required' : ''} placeholder="${f.label}" value="${value}">
      <div class="invalid-feedback">Please provide ${f.label.toLowerCase()}.</div>
    `;
    fieldsWrap.appendChild(col);
  });

  entityModal.show();
}

    $('#entityForm').addEventListener('submit', function(e){
  e.preventDefault();
  const form = e.currentTarget;
  if (!form.checkValidity()) {
    form.classList.add('was-validated');
    return;
  }
  const inputs = Array.from(form.querySelectorAll('[name]'));
  const payload = {};
  inputs.forEach(i => {
    payload[i.name] = i.value;
  });

  // if customer -> assemble address
  if (currentEditing.key === 'customers') {
    payload.house_no = payload.house_no || '';
    payload.street_name = payload.street_name || '';
    payload.city_name = payload.city_name || '';
  }

  const key = currentEditing.key;
  const baseUrl = 'http://localhost:4000/api/' + key;
  const method = (currentEditing.idx != null) ? 'PUT' : 'POST';
  // determine id field name (first field in defs)
  const idField = defs[key].fields[0].name;
  const url = (method === 'PUT') ? `${baseUrl}/${payload[idField]}` : baseUrl;

  fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(resp => {
    showToast(resp.message || 'Saved successfully', 'success');
    fetchAllData();
    entityModal.hide();
  })
  .catch(err => {
    console.error(err);
    showToast('Failed to save record', 'danger');
  });

  form.classList.remove('was-validated');
});
/* -----------------------------
  Quick add buttons
  ----------------------------- */
$('#addQuickCustomer').addEventListener('click', ()=> { document.querySelector('[data-target="customers"]').click(); setTimeout(()=>openModalForKey('customers'),200); });
$('#addQuickProduct').addEventListener('click', ()=> { document.querySelector('[data-target="products"]').click(); setTimeout(()=>openModalForKey('products'),200); });

/* -----------------------------
  Init
  ----------------------------- */
fetchAllData();


// refresh button
$('#refreshBtn').addEventListener('click', ()=> { refreshDashboard(); showToast('Dashboard refreshed','info'); });

// global search for demo: filter current visible table
$('#globalSearch').addEventListener('input', (e)=>{
  const q = e.target.value;
  const visible = document.querySelector('.view:not([style*="display: none"])');
  if (!visible) return;
  const search = visible.querySelector('[data-search]');
  if (search) search.value = q, search.dispatchEvent(new Event('input'));
});

/* -----------------------------
  Accessibility: set first nav active view
  ----------------------------- */
document.addEventListener('DOMContentLoaded', ()=> {
  document.querySelector('.nav-link.active').click();
});
</script>
</body>
</html>